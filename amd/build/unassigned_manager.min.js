define("mod_teamsattendance/unassigned_manager",["jquery","core/ajax","core/notification","core/str"],function(e,t,s,i){"use strict";var n=function(t){this.currentPage=0,this.currentFilter="all",this.currentPageSize=t.defaultPageSize||20,this.selectedRecords=new Set,this.isLoading=!1,this.cmId=t.cmId,this.sesskey=t.sesskey||M.cfg.sesskey,this.strings=t.strings||{},this.availableUsers=t.availableUsers||[],this.init()};return n.prototype={init:function(){this.loadPage(0),this.bindEvents()},bindEvents:function(){var t=this;e("#filter-select").on("change",function(){t.currentFilter=e(this).val(),t.currentPage=0,t.selectedRecords.clear(),t.updateBulkButton(),t.loadPage(0)}),e("#page-size-select").on("change",function(){t.currentPageSize=parseInt(e(this).val()),t.currentPage=0,t.loadPage(0)}),e("#refresh-btn").on("click",function(){t.loadPage(t.currentPage,!0)}),e("#bulk-assign-btn").on("click",function(){t.selectedRecords.size>0&&t.performBulkAssignment()})},loadPage:function(t,s){if(!this.isLoading){var i=this;this.isLoading=!0,e("#loading-indicator").show();var n="page_"+t+"_"+this.currentFilter+"_"+this.currentPageSize;if(!s&&sessionStorage.getItem(n)){var a=JSON.parse(sessionStorage.getItem(n));return this.renderPage(a),this.isLoading=!1,void e("#loading-indicator").hide()}e.ajax({url:window.location.href,method:"GET",data:{ajax:1,action:"load_page",page:t,per_page:this.currentPageSize,filter:this.currentFilter},success:function(e){e.success?(sessionStorage.setItem(n,JSON.stringify(e.data)),i.renderPage(e.data)):i.showError("Failed to load data: "+(e.error||"Unknown error"))},error:function(e,t,s){i.showError("Connection error: "+s)},complete:function(){i.isLoading=!1,e("#loading-indicator").hide()}})}},renderPage:function(e){this.currentPage=e.pagination.page,this.renderTable(e.records),this.renderPagination(e.pagination),this.updateBulkButton(),this.bindTableEvents()},renderTable:function(t){var s='<div class="table-responsive">';s+='<table class="table table-striped table-hover">',s+='<thead class="thead-dark">',s+="<tr>",s+='<th><input type="checkbox" id="select-all"></th>',s+="<th>"+this.strings.teams_user_id+"</th>",s+="<th>"+this.strings.attendance_duration+"</th>",s+="<th>"+this.strings.suggested_match+"</th>",s+="<th>"+this.strings.actions+"</th>",s+="</tr>",s+="</thead>",s+="<tbody>";if(0===t.length)s+='<tr><td colspan="5" class="text-center text-muted">',s+=this.strings.no_records_found,s+="</td></tr>";else for(var i=0;i<t.length;i++)s+=this.renderTableRow(t[i]);s+="</tbody></table></div>",e("#records-container").html(s)},renderTableRow:function(e){var t='<tr data-record-id="'+e.id+'">';if(t+="<td>",t+='<input type="checkbox" class="record-checkbox" value="'+e.id+'">',t+="</td>",t+="<td>"+this.escapeHtml(e.teams_user_id)+"</td>",t+="<td>"+this.formatDuration(e.attendance_duration)+"</td>",t+="<td>",e.has_suggestion&&e.suggestion){var s=e.suggestion.user,i=e.suggestion.confidence,n=e.suggestion.type;t+='<span class="badge badge-'+("high"===i?"success":"warning")+'">',t+=this.escapeHtml(s.firstname+" "+s.lastname),t+="</span>",t+='<br><small class="text-muted">'+n+" match</small>"}else t+='<span class="text-muted">'+this.strings.no_suggestion+"</span>";if(t+="</td>",t+="<td>",e.has_suggestion)t+='<button class="btn btn-sm btn-success apply-suggestion-btn" ',t+='data-record-id="'+e.id+'" ',t+='data-user-id="'+e.suggestion.user.id+'">',t+=this.strings.apply_suggestion,t+="</button>";else{t+='<select class="form-control form-control-sm manual-user-select" ',t+='data-record-id="'+e.id+'">',t+='<option value="">'+this.strings.select_user+"</option>";for(var a=0;a<this.availableUsers.length;a++){var r=this.availableUsers[a];t+='<option value="'+r.id+'">',t+=this.escapeHtml(r.firstname+" "+r.lastname),t+="</option>"}t+="</select>",t+=' <button class="btn btn-sm btn-primary manual-assign-btn" ',t+='data-record-id="'+e.id+'" disabled>',t+=this.strings.assign,t+="</button>"}return t+="</td>",t+="</tr>"},renderPagination:function(t){var s=this,i='<nav aria-label="Pagination">';i+='<ul class="pagination justify-content-center">',i+='<li class="page-item '+(t.has_previous?"":"disabled")+'">',i+='<a class="page-link" href="#" data-page="'+(t.page-1)+'">',i+=this.strings.previous,i+="</a></li>";for(var n=Math.max(0,t.page-2),a=Math.min(t.total_pages-1,t.page+2),r=n;r<=a;r++)i+='<li class="page-item '+(r===t.page?"active":"")+'">',i+='<a class="page-link" href="#" data-page="'+r+'">'+(r+1)+"</a>",i+="</li>";i+='<li class="page-item '+(t.has_next?"":"disabled")+'">',i+='<a class="page-link" href="#" data-page="'+(t.page+1)+'">',i+=this.strings.next,i+="</a></li>",i+="</ul>",i+='<div class="text-center mt-2">',i+=this.strings.page+" "+(t.page+1)+" ",i+=this.strings.of+" "+t.total_pages+" ",i+="("+t.total_count+" "+this.strings.total_records+")",i+="</div>",i+="</nav>",e("#pagination-container").html(i),e(".page-link").on("click",function(i){i.preventDefault();var n=parseInt(e(this).data("page"));n>=0&&n<t.total_pages&&s.loadPage(n)})},bindTableEvents:function(){var t=this;e("#select-all").on("change",function(s){var i=e(this).prop("checked");e(".record-checkbox").prop("checked",i),i?e(".record-checkbox").each(function(){t.selectedRecords.add(parseInt(e(this).val()))}):t.selectedRecords.clear(),t.updateBulkButton()}),e(".record-checkbox").on("change",function(s){var i=parseInt(e(this).val());e(this).prop("checked")?t.selectedRecords.add(i):t.selectedRecords.delete(i),t.updateBulkButton();var n=e(".record-checkbox").length,a=e(".record-checkbox:checked").length;e("#select-all").prop("checked",n===a)}),e(".apply-suggestion-btn").on("click",function(s){var i=e(this).data("record-id"),n=e(this).data("user-id");t.applySingleSuggestion(i,n,e(this))}),e(".manual-user-select").on("change",function(t){var s=e(this).val(),i=e(this).data("record-id"),n=e(this).siblings(".manual-assign-btn");s?n.prop("disabled",!1):n.prop("disabled",!0)}),e(".manual-assign-btn").on("click",function(s){var i=e(this).data("record-id"),n=e(this).siblings(".manual-user-select"),a=n.val();a&&t.applySingleSuggestion(i,a,e(this))})},updateBulkButton:function(){var t=this.selectedRecords.size;e("#bulk-assign-btn").prop("disabled",0===t),e("#bulk-assign-btn").text(this.strings.apply_selected+" ("+t+")")},applySingleSuggestion:function(t,s,i){var n=this;i.prop("disabled",!0).text(this.strings.applying+"..."),e.ajax({url:window.location.href,method:"POST",data:{ajax:1,action:"assign_user",recordid:t,userid:s,sesskey:this.sesskey},success:function(s){s.success?(e('tr[data-record-id="'+t+'"]').fadeOut(),n.selectedRecords.delete(t),n.updateBulkButton(),sessionStorage.clear(),n.showSuccess(s.message)):(n.showError(s.error),i.prop("disabled",!1).text(n.strings.apply_suggestion))},error:function(){n.showError("Connection error"),i.prop("disabled",!1).text(n.strings.apply_suggestion)}})},performBulkAssignment:function(){if(0!==this.selectedRecords.size){var t=this;e("#progress-container").show(),e("#bulk-assign-btn").prop("disabled",!0);var s={};this.selectedRecords.forEach(function(t){var i=e('tr[data-record-id="'+t+'"]'),n=i.find(".apply-suggestion-btn");if(n.length)s[t]=n.data("user-id");else{var a=i.find(".manual-user-select");a.length&&a.val()&&(s[t]=a.val())}}),e.ajax({url:window.location.href,method:"POST",data:{ajax:1,action:"bulk_assign",assignments:s,sesskey:this.sesskey},success:function(s){if(s.success){var i=s.data;e("#progress-bar").css("width","100%").addClass("bg-success"),e("#progress-text").text("Complete: "+i.successful+"/"+i.total+" successful"),t.selectedRecords.clear(),sessionStorage.clear(),setTimeout(function(){e("#progress-container").hide(),t.loadPage(t.currentPage,!0)},2e3),t.showSuccess("Bulk assignment completed: "+i.successful+" successful, "+i.failed+" failed")}else t.showError(s.error)},error:function(){t.showError("Connection error during bulk assignment")},complete:function(){e("#bulk-assign-btn").prop("disabled",!1)}})}},formatDuration:function(e){var t=Math.floor(e/3600),s=Math.floor(e%3600/60);return t+"h "+s+"m"},escapeHtml:function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML},showSuccess:function(e){this.showToast(e,"success",5e3)},showError:function(e){this.showToast(e,"danger",8e3)},showToast:function(t,s,i){var n=e('<div class="alert alert-'+s+' alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;"><button type="button" class="close" data-dismiss="alert">&times;</button>'+t+"</div>");e("body").append(n),setTimeout(function(){n.remove()},i)}},{init:function(e){return new n(e)}}});
